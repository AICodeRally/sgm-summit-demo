// This is your Prisma schema file
// STRICT: Use ONLY Prisma Migrate - NO db push --accept-data-loss
// Schema: sgm_summit_demo (isolated from other schemas)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// =============================================================================
// TENANT & AUTH MODELS
// =============================================================================

// Tenant Model - Multi-tenancy support
model Tenant {
  id        String   @id @default(cuid())
  name      String   @db.VarChar(200)
  slug      String   @unique @db.VarChar(50)

  // Tier & Status
  tier      TenantTier
  status    TenantStatus

  // Features & Settings (JSON for flexibility)
  features  Json     @db.JsonB // maxDocuments, maxUsers, aiEnabled, etc.
  settings  Json     @db.JsonB // branding, industry, customizations

  // Lifecycle
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  expiresAt DateTime? @map("expires_at") // For trial/beta tenants

  // Relations
  users      User[]
  policies   Policy[]
  territories Territory[]
  documents  Document[]
  approvals  Approval[]
  auditLogs  AuditLog[]
  committees Committee[]
  cases      Case[]
  planTemplates PlanTemplate[]
  plans      Plan[]
  governanceFrameworks GovernanceFramework[]

  @@index([slug])
  @@index([status])
  @@index([tier])
  @@map("tenants")
}

enum TenantTier {
  DEMO
  BETA
  PRODUCTION
}

enum TenantStatus {
  ACTIVE
  SUSPENDED
  TRIAL
  EXPIRED
}

// User Model - NextAuth compatible
model User {
  id            String    @id @default(cuid())
  name          String?   @db.VarChar(200)
  email         String    @unique @db.VarChar(255)
  emailVerified DateTime? @map("email_verified")
  image         String?   @db.VarChar(500)

  // Role & Tenant
  role          UserRole  @default(USER)
  tenantId      String    @map("tenant_id")
  tenant        Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // NextAuth relations
  accounts      Account[]
  sessions      Session[]

  // Audit
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([email])
  @@map("users")
}

enum UserRole {
  SUPER_ADMIN  // Platform admin (cross-tenant)
  ADMIN        // Tenant admin
  MANAGER      // Committee member, can approve
  USER         // Standard user
  VIEWER       // Read-only access
}

// Account Model - NextAuth OAuth accounts
model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String  @db.VarChar(50)
  provider          String  @db.VarChar(50)
  providerAccountId String  @map("provider_account_id") @db.VarChar(255)
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String? @db.VarChar(50)
  scope             String? @db.Text
  id_token          String? @db.Text
  session_state     String? @db.Text

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

// Session Model - NextAuth sessions
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token") @db.VarChar(255)
  userId       String   @map("user_id")
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

// VerificationToken Model - NextAuth email verification
model VerificationToken {
  identifier String   @db.VarChar(255)
  token      String   @unique @db.VarChar(255)
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// =============================================================================
// GOVERNANCE MODELS (with tenant relations)
// =============================================================================

// Policy Model
model Policy {
  id        String   @id @default(cuid())
  tenantId  String   @map("tenant_id")
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Metadata
  name        String   @db.VarChar(200)
  description String?  @db.Text
  category    String?  @db.VarChar(100)

  // Versioning
  version     String   @db.VarChar(20)
  status      String   @db.VarChar(20) // draft, published, superseded, retired

  // Effective Dating
  effectiveDate   DateTime  @map("effective_date")
  expirationDate  DateTime? @map("expiration_date")

  // Content
  content String @db.Text

  // Relationships
  parentPolicyId      String?  @map("parent_policy_id")
  supersededByPolicyId String? @map("superseded_by_policy_id")

  // Approval
  approvalRequired    Boolean   @default(true) @map("approval_required")
  approvalWorkflowId  String?   @map("approval_workflow_id")
  approvedBy          String?   @map("approved_by")
  approvedAt          DateTime? @map("approved_at")

  // Audit
  createdBy String    @map("created_by")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedBy String?   @map("updated_by")
  updatedAt DateTime? @updatedAt @map("updated_at")

  // Metadata JSON
  metadata Json? @db.JsonB

  @@index([tenantId])
  @@index([status])
  @@index([effectiveDate])
  @@map("policies")
}

// Territory Model
model Territory {
  id        String   @id @default(cuid())
  tenantId  String   @map("tenant_id")
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Metadata
  code        String  @db.VarChar(50)
  name        String  @db.VarChar(200)
  description String? @db.Text
  type        String  @db.VarChar(20) // geographic, account, industry, named
  status      String  @db.VarChar(20) // active, inactive, archived

  // Hierarchy
  parentTerritoryId String? @map("parent_territory_id")
  level             Int     @default(0)
  path              String? @db.VarChar(500)

  // Assignment
  assignedToUserId String?   @map("assigned_to_user_id")
  assignedAt       DateTime? @map("assigned_at")

  // Coverage Rules
  coverageRules Json? @map("coverage_rules") @db.JsonB

  // Effective Dating
  effectiveDate   DateTime  @map("effective_date")
  expirationDate  DateTime? @map("expiration_date")

  // Audit
  createdBy String    @map("created_by")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedBy String?   @map("updated_by")
  updatedAt DateTime? @updatedAt @map("updated_at")

  // Metadata
  metadata Json? @db.JsonB

  @@index([tenantId])
  @@index([status])
  @@index([type])
  @@index([parentTerritoryId])
  @@map("territories")
}

// Document Model
model Document {
  id           String   @id @default(cuid())
  tenantId     String   @map("tenant_id")
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  documentCode String   @map("document_code") @db.VarChar(50)

  // Metadata
  title         String   @db.VarChar(200)
  description   String?  @db.Text
  documentType  String   @map("document_type") @db.VarChar(20)
  category      String?  @db.VarChar(100)
  tags          String[] @db.VarChar(50)

  // Versioning
  version String @db.VarChar(20)
  status  String @db.VarChar(20)

  // Lifecycle Dates
  createdAt       DateTime  @default(now()) @map("created_at")
  lastUpdated     DateTime  @updatedAt @map("last_updated")
  effectiveDate   DateTime? @map("effective_date")
  expirationDate  DateTime? @map("expiration_date")
  nextReview      DateTime? @map("next_review")

  // File Storage
  fileType String @map("file_type") @db.VarChar(10)
  filePath String @map("file_path") @db.VarChar(500)
  fileSize Int    @map("file_size")
  checksum String? @db.VarChar(64)

  // Ownership & Approval
  owner               String  @db.VarChar(200)
  createdBy           String  @map("created_by") @db.VarChar(200)
  updatedBy           String? @map("updated_by") @db.VarChar(200)
  approvers           Json?   @db.JsonB
  approvalWorkflowId  String? @map("approval_workflow_id")
  legalReviewStatus   String  @default("NOT_REQUIRED") @map("legal_review_status") @db.VarChar(20)

  // Relationships
  relatedDocs   String[] @map("related_docs") @db.VarChar(50)
  referencedBy  String[] @map("referenced_by") @db.VarChar(50)
  supersedes    String?  @db.VarChar(50)
  supersededBy  String?  @map("superseded_by") @db.VarChar(50)

  // Compliance
  retentionPeriod  Int      @default(7) @map("retention_period")
  complianceFlags  String[] @map("compliance_flags") @db.VarChar(50)

  // Metadata
  metadata Json? @db.JsonB

  @@unique([tenantId, documentCode])
  @@index([tenantId])
  @@index([documentType])
  @@index([status])
  @@map("documents")
}

// Approval Model
model Approval {
  id        String   @id @default(cuid())
  tenantId  String   @map("tenant_id")
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Metadata
  title       String  @db.VarChar(200)
  description String? @db.Text
  priority    String  @default("medium") @db.VarChar(20)
  status      String  @default("pending") @db.VarChar(20)

  // Request Details
  entityType  String @map("entity_type") @db.VarChar(50)
  entityId    String @map("entity_id")
  requestType String @map("request_type") @db.VarChar(50)
  requestData Json   @map("request_data") @db.JsonB

  // Workflow
  workflowId  String? @map("workflow_id")
  currentStep Int     @default(0) @map("current_step")
  totalSteps  Int     @default(1) @map("total_steps")

  // Submitter
  submittedBy String   @map("submitted_by")
  submittedAt DateTime @default(now()) @map("submitted_at")

  // SLA
  slaDeadline DateTime? @map("sla_deadline")
  escalatedAt DateTime? @map("escalated_at")

  // Resolution
  decidedBy    String?   @map("decided_by")
  decidedAt    DateTime? @map("decided_at")
  decision     String?   @db.VarChar(20)
  decisionNotes String?  @map("decision_notes") @db.Text

  // Audit
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")

  // Metadata
  metadata Json? @db.JsonB

  @@index([tenantId])
  @@index([status])
  @@index([entityType, entityId])
  @@map("approvals")
}

// Audit Log Model
model AuditLog {
  id       String @id @default(cuid())
  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Event Details
  eventType String @map("event_type") @db.VarChar(50)
  severity  String @default("info") @db.VarChar(20)
  message   String @db.VarChar(500)

  // Entity Context
  entityType String  @map("entity_type") @db.VarChar(50)
  entityId   String  @map("entity_id")
  entityName String? @map("entity_name") @db.VarChar(200)

  // Actor
  actorId   String  @map("actor_id")
  actorName String? @map("actor_name") @db.VarChar(200)
  actorRole String? @map("actor_role") @db.VarChar(100)

  // Changes
  changesBefore Json? @map("changes_before") @db.JsonB
  changesAfter  Json? @map("changes_after") @db.JsonB

  // Request Context
  requestId String? @map("request_id")
  ipAddress String? @map("ip_address") @db.VarChar(45)
  userAgent String? @map("user_agent") @db.VarChar(500)

  // Timestamp (immutable)
  occurredAt DateTime @default(now()) @map("occurred_at")

  // Metadata
  metadata Json? @db.JsonB

  @@index([tenantId])
  @@index([eventType])
  @@index([entityType, entityId])
  @@index([actorId])
  @@index([occurredAt])
  @@map("audit_logs")
}

// Committee Model
model Committee {
  id       String @id @default(cuid())
  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Metadata
  code        String  @db.VarChar(50)
  name        String  @db.VarChar(200)
  description String? @db.Text
  type        String  @db.VarChar(50) // SGCC, CRB, etc.

  // Charter
  charter            String? @db.Text
  meetingFrequency   String? @map("meeting_frequency") @db.VarChar(50)
  quorumRequirement  Int?    @map("quorum_requirement")

  // Members (stored as JSON for flexibility)
  votingMembers    Json? @map("voting_members") @db.JsonB
  nonVotingMembers Json? @map("non_voting_members") @db.JsonB
  advisors         Json? @db.JsonB

  // Authority
  approvalAuthority Json? @map("approval_authority") @db.JsonB

  // Status
  status String @default("active") @db.VarChar(20)

  // Audit
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")

  // Metadata
  metadata Json? @db.JsonB

  @@index([tenantId])
  @@index([type])
  @@index([status])
  @@unique([tenantId, code])
  @@map("committees")
}

// Case Model
model Case {
  id       String @id @default(cuid())
  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Metadata
  caseNumber  String  @unique @map("case_number") @db.VarChar(50)
  title       String  @db.VarChar(200)
  description String? @db.Text
  caseType    String  @map("case_type") @db.VarChar(50)
  priority    String  @default("MEDIUM") @db.VarChar(20)
  status      String  @default("NEW") @db.VarChar(20)

  // Assignment
  assignedTo   String?   @map("assigned_to") @db.VarChar(200)
  committeeId  String?   @map("committee_id")

  // Submitter
  submittedBy  String    @map("submitted_by") @db.VarChar(200)
  submittedAt  DateTime  @default(now()) @map("submitted_at")

  // Financial Impact
  financialImpact     Decimal? @map("financial_impact") @db.Decimal(12, 2)
  financialImpactType String?  @map("financial_impact_type") @db.VarChar(50)

  // Resolution
  resolvedBy  String?   @map("resolved_by") @db.VarChar(200)
  resolvedAt  DateTime? @map("resolved_at")
  resolution  String?   @db.Text

  // SLA
  slaDeadline      DateTime? @map("sla_deadline")
  businessDaysUsed Int?      @map("business_days_used")
  isOverdue        Boolean   @default(false) @map("is_overdue")

  // Timeline (stored as JSON array)
  timeline Json? @db.JsonB

  // Attachments
  attachments Json? @db.JsonB

  // Audit
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")

  // Metadata
  metadata Json? @db.JsonB

  @@index([tenantId])
  @@index([caseType])
  @@index([status])
  @@index([priority])
  @@index([assignedTo])
  @@index([submittedAt])
  @@map("cases")
}

// =============================================================================
// PLAN MANAGEMENT MODELS
// =============================================================================

// Plan Template Model - Reusable templates for creating plans
model PlanTemplate {
  id                String   @id @default(cuid())
  tenantId          String   @map("tenant_id")
  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Metadata
  code              String   @unique @db.VarChar(50)
  name              String   @db.VarChar(200)
  description       String?  @db.Text
  planType          String   @map("plan_type") @db.VarChar(50)  // COMPENSATION_PLAN, GOVERNANCE_PLAN, POLICY_CREATION_PLAN
  category          String?  @db.VarChar(100)
  tags              String[] @db.VarChar(50)

  // Versioning
  version           String   @db.VarChar(20)
  status            String   @db.VarChar(20)  // DRAFT, ACTIVE, DEPRECATED, ARCHIVED

  // Source & Cloning
  source            String   @db.VarChar(20)  // SYSTEM, USER_CREATED, CLONED
  isSystemTemplate  Boolean  @default(false) @map("is_system_template")
  clonedFromId      String?  @map("cloned_from_id")

  // Ownership
  owner             String   @db.VarChar(200)
  createdBy         String   @map("created_by") @db.VarChar(200)

  // Dates
  createdAt         DateTime @default(now()) @map("created_at")
  lastUpdated       DateTime @updatedAt @map("last_updated")
  effectiveDate     DateTime? @map("effective_date")

  // Usage Stats
  usageCount        Int      @default(0) @map("usage_count")

  // Metadata JSON
  metadata          Json?    @db.JsonB

  // Relations
  sections          TemplateSection[]
  plans             Plan[]   @relation("PlanToTemplate")

  @@index([tenantId])
  @@index([planType])
  @@index([status])
  @@index([isSystemTemplate])
  @@map("plan_templates")
}

// Template Section Model - Sections within a plan template
model TemplateSection {
  id                String        @id @default(cuid())
  templateId        String        @map("template_id")
  template          PlanTemplate  @relation(fields: [templateId], references: [id], onDelete: Cascade)

  // Hierarchy
  parentSectionId   String?       @map("parent_section_id")
  sectionKey        String        @map("section_key") @db.VarChar(100)
  level             Int           @default(0)
  orderIndex        Int           @map("order_index")

  // Metadata
  title             String        @db.VarChar(200)
  description       String?       @db.Text

  // Requirements
  isRequired        Boolean       @default(false) @map("is_required")
  isRepeatable      Boolean       @default(false) @map("is_repeatable")

  // Content Template
  contentTemplate   String?       @map("content_template") @db.Text

  // Field Definitions (JSON array of FieldDefinition objects)
  fieldDefinitions  Json?         @map("field_definitions") @db.JsonB

  // AI Agent Roles
  aiAgentRoles      String[]      @map("ai_agent_roles") @db.VarChar(50)

  // Metadata
  metadata          Json?         @db.JsonB

  @@index([templateId])
  @@index([parentSectionId])
  @@map("template_sections")
}

// Plan Model - Instance of a plan being created/edited
model Plan {
  id                      String      @id @default(cuid())
  tenantId                String      @map("tenant_id")
  tenant                  Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Metadata
  planCode                String      @unique @map("plan_code") @db.VarChar(50)
  title                   String      @db.VarChar(200)
  description             String?     @db.Text
  planType                String      @map("plan_type") @db.VarChar(50)
  category                String?     @db.VarChar(100)
  tags                    String[]    @db.VarChar(50)

  // Versioning
  version                 String      @db.VarChar(20)
  status                  String      @db.VarChar(20)  // DRAFT, IN_PROGRESS, UNDER_REVIEW, PENDING_APPROVAL, APPROVED, PUBLISHED, SUPERSEDED, ARCHIVED

  // Template Relationship
  createdFromTemplateId   String?     @map("created_from_template_id")
  template                PlanTemplate? @relation("PlanToTemplate", fields: [createdFromTemplateId], references: [id])
  templateSnapshot        Json?       @map("template_snapshot") @db.JsonB

  // Ownership
  owner                   String      @db.VarChar(200)
  createdBy               String      @map("created_by") @db.VarChar(200)
  updatedBy               String?     @map("updated_by") @db.VarChar(200)

  // Approval
  approvalWorkflowId      String?     @map("approval_workflow_id")

  // Dates
  createdAt               DateTime    @default(now()) @map("created_at")
  lastUpdated             DateTime    @updatedAt @map("last_updated")
  effectiveDate           DateTime?   @map("effective_date")
  expirationDate          DateTime?   @map("expiration_date")
  publishedAt             DateTime?   @map("published_at")

  // Document Link
  documentId              String?     @map("document_id")

  // Versioning Chain
  supersedes              String?
  supersededBy            String?     @map("superseded_by")

  // Completion Tracking
  completionPercentage    Int         @default(0) @map("completion_percentage")
  sectionsCompleted       Int         @default(0) @map("sections_completed")
  sectionsTotal           Int         @default(0) @map("sections_total")

  // Metadata
  metadata                Json?       @db.JsonB

  // Relations
  sections                PlanSection[]

  @@index([tenantId])
  @@index([planType])
  @@index([status])
  @@index([owner])
  @@index([createdFromTemplateId])
  @@map("plans")
}

// Plan Section Model - Individual section within a plan instance
model PlanSection {
  id                    String      @id @default(cuid())
  planId                String      @map("plan_id")
  plan                  Plan        @relation(fields: [planId], references: [id], onDelete: Cascade)

  // Hierarchy
  parentSectionId       String?     @map("parent_section_id")
  sectionKey            String      @map("section_key") @db.VarChar(100)
  level                 Int         @default(0)
  orderIndex            Int         @map("order_index")

  // Metadata
  title                 String      @db.VarChar(200)
  description           String?     @db.Text

  // Requirements
  isRequired            Boolean     @default(false) @map("is_required")

  // Content
  content               String?     @db.Text

  // Field Values (JSON array of FieldValue objects)
  fieldValues           Json?       @map("field_values") @db.JsonB

  // AI Agent Roles
  aiAgentRoles          String[]    @map("ai_agent_roles") @db.VarChar(50)

  // Completion Tracking
  completionStatus      String      @default("NOT_STARTED") @map("completion_status") @db.VarChar(20)
  completionPercentage  Int         @default(0) @map("completion_percentage")

  // Review
  reviewedBy            String?     @map("reviewed_by") @db.VarChar(200)
  reviewedAt            DateTime?   @map("reviewed_at")
  reviewComments        String?     @map("review_comments") @db.Text

  // Dates
  createdAt             DateTime    @default(now()) @map("created_at")
  lastUpdated           DateTime    @updatedAt @map("last_updated")

  // Metadata
  metadata              Json?       @db.JsonB

  @@index([planId])
  @@index([parentSectionId])
  @@index([completionStatus])
  @@map("plan_sections")
}

// Governance Framework Model - SPM methodology and governance guardrails
model GovernanceFramework {
  id            String   @id @default(cuid())
  tenantId      String   @map("tenant_id")
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Metadata
  code          String   @unique @db.VarChar(50)
  title         String   @db.VarChar(200)
  category      String   @db.VarChar(100)

  // Content
  content       String   @db.Text

  // Versioning
  version       String   @db.VarChar(20)
  status        String   @db.VarChar(20)  // DRAFT, ACTIVE, SUPERSEDED

  // Applicability
  isGlobal      Boolean  @default(false) @map("is_global")
  isMandatory   Boolean  @default(false) @map("is_mandatory")
  applicableTo  String[] @map("applicable_to") @db.VarChar(50)

  // Ownership
  createdBy     String   @map("created_by") @db.VarChar(200)

  // Dates
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([category])
  @@index([status])
  @@index([isGlobal])
  @@map("governance_frameworks")
}

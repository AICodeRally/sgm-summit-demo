// This is your Prisma schema file
// STRICT: Use ONLY Prisma Migrate - NO db push --accept-data-loss
// Schema: sgm_summit_demo (isolated from other schemas)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// =============================================================================
// TENANT & AUTH MODELS
// =============================================================================

// Tenant Model - Multi-tenancy support
model Tenant {
  id        String   @id @default(cuid())
  name      String  
  slug      String   @unique

  // Tier & Status
  tier      TenantTier
  status    TenantStatus

  // Features & Settings (JSON for flexibility)
  features  Json     // maxDocuments, maxUsers, aiEnabled, etc.
  settings  Json     // branding, industry, customizations

  // Lifecycle
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  expiresAt DateTime? @map("expires_at") // For trial/beta tenants

  // Relations
  users      User[]
  policies   Policy[]
  territories Territory[]
  documents  Document[]
  approvals  Approval[]
  auditLogs  AuditLog[]
  committees Committee[]
  cases      Case[]
  planTemplates PlanTemplate[]
  plans      Plan[]
  governanceFrameworks GovernanceFramework[]

  @@index([slug])
  @@index([status])
  @@index([tier])
  @@map("tenants")
}

enum TenantTier {
  DEMO
  BETA
  PRODUCTION
}

enum TenantStatus {
  ACTIVE
  SUSPENDED
  TRIAL
  EXPIRED
}

// User Model - NextAuth compatible
model User {
  id            String    @id @default(cuid())
  name          String?  
  email         String    @unique
  emailVerified DateTime? @map("email_verified")
  image         String?  

  // Role & Tenant
  role          UserRole  @default(USER)
  tenantId      String    @map("tenant_id")
  tenant        Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // NextAuth relations
  accounts      Account[]
  sessions      Session[]

  // Audit
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([email])
  @@map("users")
}

enum UserRole {
  SUPER_ADMIN  // Platform admin (cross-tenant)
  ADMIN        // Tenant admin
  MANAGER      // Committee member, can approve
  USER         // Standard user
  VIEWER       // Read-only access
}

// Account Model - NextAuth OAuth accounts
model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String 
  provider          String 
  providerAccountId String  @map("provider_account_id")
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

// Session Model - NextAuth sessions
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

// VerificationToken Model - NextAuth email verification
model VerificationToken {
  identifier String  
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// =============================================================================
// GOVERNANCE MODELS (with tenant relations)
// =============================================================================

// Policy Model
model Policy {
  id        String   @id @default(cuid())
  tenantId  String   @map("tenant_id")
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Metadata
  name        String  
  description String? 
  category    String? 

  // Versioning
  version     String  
  status      String   // draft, published, superseded, retired

  // Effective Dating
  effectiveDate   DateTime  @map("effective_date")
  expirationDate  DateTime? @map("expiration_date")

  // Content
  content String

  // Relationships
  parentPolicyId      String?  @map("parent_policy_id")
  supersededByPolicyId String? @map("superseded_by_policy_id")

  // Approval
  approvalRequired    Boolean   @default(true) @map("approval_required")
  approvalWorkflowId  String?   @map("approval_workflow_id")
  approvedBy          String?   @map("approved_by")
  approvedAt          DateTime? @map("approved_at")

  // Audit
  createdBy String    @map("created_by")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedBy String?   @map("updated_by")
  updatedAt DateTime? @updatedAt @map("updated_at")

  // Metadata JSON
  metadata Json?

  @@index([tenantId])
  @@index([status])
  @@index([effectiveDate])
  @@map("policies")
}

// Territory Model
model Territory {
  id        String   @id @default(cuid())
  tenantId  String   @map("tenant_id")
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Metadata
  code        String 
  name        String 
  description String?
  type        String  // geographic, account, industry, named
  status      String  // active, inactive, archived

  // Hierarchy
  parentTerritoryId String? @map("parent_territory_id")
  level             Int     @default(0)
  path              String?

  // Assignment
  assignedToUserId String?   @map("assigned_to_user_id")
  assignedAt       DateTime? @map("assigned_at")

  // Coverage Rules
  coverageRules Json? @map("coverage_rules")

  // Effective Dating
  effectiveDate   DateTime  @map("effective_date")
  expirationDate  DateTime? @map("expiration_date")

  // Audit
  createdBy String    @map("created_by")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedBy String?   @map("updated_by")
  updatedAt DateTime? @updatedAt @map("updated_at")

  // Metadata
  metadata Json?

  @@index([tenantId])
  @@index([status])
  @@index([type])
  @@index([parentTerritoryId])
  @@map("territories")
}

// Document Model
model Document {
  id           String   @id @default(cuid())
  tenantId     String   @map("tenant_id")
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  documentCode String   @map("document_code")

  // Metadata
  title         String  
  description   String? 
  documentType  String   @map("document_type")
  category      String? 
  tags          Json

  // Versioning
  version String
  status  String

  // Lifecycle Dates
  createdAt       DateTime  @default(now()) @map("created_at")
  lastUpdated     DateTime  @updatedAt @map("last_updated")
  effectiveDate   DateTime? @map("effective_date")
  expirationDate  DateTime? @map("expiration_date")
  nextReview      DateTime? @map("next_review")

  // File Storage
  fileType String @map("file_type")
  filePath String @map("file_path")
  fileSize Int    @map("file_size")
  checksum String?

  // Ownership & Approval
  owner               String 
  createdBy           String  @map("created_by")
  updatedBy           String? @map("updated_by")
  approvers           Json?  
  approvalWorkflowId  String? @map("approval_workflow_id")
  legalReviewStatus   String  @default("NOT_REQUIRED") @map("legal_review_status")

  // Relationships
  relatedDocs   Json @map("related_docs")
  referencedBy  Json @map("referenced_by")
  supersedes    String? 
  supersededBy  String?  @map("superseded_by")

  // Compliance
  retentionPeriod  Int      @default(7) @map("retention_period")
  complianceFlags  Json @map("compliance_flags")

  // Metadata
  metadata Json?

  @@unique([tenantId, documentCode])
  @@index([tenantId])
  @@index([documentType])
  @@index([status])
  @@map("documents")
}

// Approval Model
model Approval {
  id        String   @id @default(cuid())
  tenantId  String   @map("tenant_id")
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Metadata
  title       String 
  description String?
  priority    String  @default("medium")
  status      String  @default("pending")

  // Request Details
  entityType  String @map("entity_type")
  entityId    String @map("entity_id")
  requestType String @map("request_type")
  requestData Json   @map("request_data")

  // Workflow
  workflowId  String? @map("workflow_id")
  currentStep Int     @default(0) @map("current_step")
  totalSteps  Int     @default(1) @map("total_steps")

  // Submitter
  submittedBy String   @map("submitted_by")
  submittedAt DateTime @default(now()) @map("submitted_at")

  // SLA
  slaDeadline DateTime? @map("sla_deadline")
  escalatedAt DateTime? @map("escalated_at")

  // Resolution
  decidedBy    String?   @map("decided_by")
  decidedAt    DateTime? @map("decided_at")
  decision     String?  
  decisionNotes String?  @map("decision_notes")

  // Audit
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")

  // Metadata
  metadata Json?

  @@index([tenantId])
  @@index([status])
  @@index([entityType, entityId])
  @@map("approvals")
}

// Audit Log Model
model AuditLog {
  id       String @id @default(cuid())
  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Event Details
  eventType String @map("event_type")
  severity  String @default("info")
  message   String

  // Entity Context
  entityType String  @map("entity_type")
  entityId   String  @map("entity_id")
  entityName String? @map("entity_name")

  // Actor
  actorId   String  @map("actor_id")
  actorName String? @map("actor_name")
  actorRole String? @map("actor_role")

  // Changes
  changesBefore Json? @map("changes_before")
  changesAfter  Json? @map("changes_after")

  // Request Context
  requestId String? @map("request_id")
  ipAddress String? @map("ip_address")
  userAgent String? @map("user_agent")

  // Timestamp (immutable)
  occurredAt DateTime @default(now()) @map("occurred_at")

  // Metadata
  metadata Json?

  @@index([tenantId])
  @@index([eventType])
  @@index([entityType, entityId])
  @@index([actorId])
  @@index([occurredAt])
  @@map("audit_logs")
}

// Committee Model
model Committee {
  id       String @id @default(cuid())
  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Metadata
  code        String 
  name        String 
  description String?
  type        String  // SGCC, CRB, etc.

  // Charter
  charter            String?
  meetingFrequency   String? @map("meeting_frequency")
  quorumRequirement  Int?    @map("quorum_requirement")

  // Members (stored as JSON for flexibility)
  votingMembers    Json? @map("voting_members")
  nonVotingMembers Json? @map("non_voting_members")
  advisors         Json?

  // Authority
  approvalAuthority Json? @map("approval_authority")

  // Status
  status String @default("active")

  // Audit
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")

  // Metadata
  metadata Json?

  @@index([tenantId])
  @@index([type])
  @@index([status])
  @@unique([tenantId, code])
  @@map("committees")
}

// Case Model
model Case {
  id       String @id @default(cuid())
  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Metadata
  caseNumber  String  @unique @map("case_number")
  title       String 
  description String?
  caseType    String  @map("case_type")
  priority    String  @default("MEDIUM")
  status      String  @default("NEW")

  // Assignment
  assignedTo   String?   @map("assigned_to")
  committeeId  String?   @map("committee_id")

  // Submitter
  submittedBy  String    @map("submitted_by")
  submittedAt  DateTime  @default(now()) @map("submitted_at")

  // Financial Impact
  financialImpact     Decimal? @map("financial_impact")
  financialImpactType String?  @map("financial_impact_type")

  // Resolution
  resolvedBy  String?   @map("resolved_by")
  resolvedAt  DateTime? @map("resolved_at")
  resolution  String?  

  // SLA
  slaDeadline      DateTime? @map("sla_deadline")
  businessDaysUsed Int?      @map("business_days_used")
  isOverdue        Boolean   @default(false) @map("is_overdue")

  // Timeline (stored as JSON array)
  timeline Json?

  // Attachments
  attachments Json?

  // Audit
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")

  // Metadata
  metadata Json?

  @@index([tenantId])
  @@index([caseType])
  @@index([status])
  @@index([priority])
  @@index([assignedTo])
  @@index([submittedAt])
  @@map("cases")
}

// =============================================================================
// PLAN MANAGEMENT MODELS
// =============================================================================

// Plan Template Model - Reusable templates for creating plans
model PlanTemplate {
  id                String   @id @default(cuid())
  tenantId          String   @map("tenant_id")
  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Metadata
  code              String   @unique
  name              String  
  description       String? 
  planType          String   @map("plan_type")  // COMPENSATION_PLAN, GOVERNANCE_PLAN, POLICY_CREATION_PLAN
  category          String? 
  tags              Json

  // Versioning
  version           String  
  status            String    // DRAFT, ACTIVE, DEPRECATED, ARCHIVED

  // Source & Cloning
  source            String    // SYSTEM, USER_CREATED, CLONED
  isSystemTemplate  Boolean  @default(false) @map("is_system_template")
  clonedFromId      String?  @map("cloned_from_id")

  // Ownership
  owner             String  
  createdBy         String   @map("created_by")

  // Dates
  createdAt         DateTime @default(now()) @map("created_at")
  lastUpdated       DateTime @updatedAt @map("last_updated")
  effectiveDate     DateTime? @map("effective_date")

  // Usage Stats
  usageCount        Int      @default(0) @map("usage_count")

  // Metadata JSON
  metadata          Json?   

  // Relations
  sections          TemplateSection[]
  plans             Plan[]   @relation("PlanToTemplate")

  @@index([tenantId])
  @@index([planType])
  @@index([status])
  @@index([isSystemTemplate])
  @@map("plan_templates")
}

// Template Section Model - Sections within a plan template
model TemplateSection {
  id                String        @id @default(cuid())
  templateId        String        @map("template_id")
  template          PlanTemplate  @relation(fields: [templateId], references: [id], onDelete: Cascade)

  // Hierarchy
  parentSectionId   String?       @map("parent_section_id")
  sectionKey        String        @map("section_key")
  level             Int           @default(0)
  orderIndex        Int           @map("order_index")

  // Metadata
  title             String       
  description       String?      

  // Requirements
  isRequired        Boolean       @default(false) @map("is_required")
  isRepeatable      Boolean       @default(false) @map("is_repeatable")

  // Content Template
  contentTemplate   String?       @map("content_template")

  // Field Definitions (JSON array of FieldDefinition objects)
  fieldDefinitions  Json?         @map("field_definitions")

  // AI Agent Roles
  aiAgentRoles      Json      @map("ai_agent_roles")

  // Metadata
  metadata          Json?        

  @@index([templateId])
  @@index([parentSectionId])
  @@map("template_sections")
}

// Plan Model - Instance of a plan being created/edited
model Plan {
  id                      String      @id @default(cuid())
  tenantId                String      @map("tenant_id")
  tenant                  Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Metadata
  planCode                String      @unique @map("plan_code")
  title                   String     
  description             String?    
  planType                String      @map("plan_type")
  category                String?    
  tags                    Json   

  // Versioning
  version                 String     
  status                  String       // DRAFT, IN_PROGRESS, UNDER_REVIEW, PENDING_APPROVAL, APPROVED, PUBLISHED, SUPERSEDED, ARCHIVED

  // Template Relationship
  createdFromTemplateId   String?     @map("created_from_template_id")
  template                PlanTemplate? @relation("PlanToTemplate", fields: [createdFromTemplateId], references: [id])
  templateSnapshot        Json?       @map("template_snapshot")

  // Ownership
  owner                   String     
  createdBy               String      @map("created_by")
  updatedBy               String?     @map("updated_by")

  // Approval
  approvalWorkflowId      String?     @map("approval_workflow_id")

  // Dates
  createdAt               DateTime    @default(now()) @map("created_at")
  lastUpdated             DateTime    @updatedAt @map("last_updated")
  effectiveDate           DateTime?   @map("effective_date")
  expirationDate          DateTime?   @map("expiration_date")
  publishedAt             DateTime?   @map("published_at")

  // Document Link
  documentId              String?     @map("document_id")

  // Versioning Chain
  supersedes              String?
  supersededBy            String?     @map("superseded_by")

  // Completion Tracking
  completionPercentage    Int         @default(0) @map("completion_percentage")
  sectionsCompleted       Int         @default(0) @map("sections_completed")
  sectionsTotal           Int         @default(0) @map("sections_total")

  // Metadata
  metadata                Json?      

  // Relations
  sections                PlanSection[]

  @@index([tenantId])
  @@index([planType])
  @@index([status])
  @@index([owner])
  @@index([createdFromTemplateId])
  @@map("plans")
}

// Plan Section Model - Individual section within a plan instance
model PlanSection {
  id                    String      @id @default(cuid())
  planId                String      @map("plan_id")
  plan                  Plan        @relation(fields: [planId], references: [id], onDelete: Cascade)

  // Hierarchy
  parentSectionId       String?     @map("parent_section_id")
  sectionKey            String      @map("section_key")
  level                 Int         @default(0)
  orderIndex            Int         @map("order_index")

  // Metadata
  title                 String     
  description           String?    

  // Requirements
  isRequired            Boolean     @default(false) @map("is_required")

  // Content
  content               String?    

  // Field Values (JSON array of FieldValue objects)
  fieldValues           Json?       @map("field_values")

  // AI Agent Roles
  aiAgentRoles          Json    @map("ai_agent_roles")

  // Completion Tracking
  completionStatus      String      @default("NOT_STARTED") @map("completion_status")
  completionPercentage  Int         @default(0) @map("completion_percentage")

  // Review
  reviewedBy            String?     @map("reviewed_by")
  reviewedAt            DateTime?   @map("reviewed_at")
  reviewComments        String?     @map("review_comments")

  // Dates
  createdAt             DateTime    @default(now()) @map("created_at")
  lastUpdated           DateTime    @updatedAt @map("last_updated")

  // Metadata
  metadata              Json?      

  @@index([planId])
  @@index([parentSectionId])
  @@index([completionStatus])
  @@map("plan_sections")
}

// Governance Framework Model - SPM methodology and governance guardrails
model GovernanceFramework {
  id            String   @id @default(cuid())
  tenantId      String   @map("tenant_id")
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Metadata
  code          String   @unique
  title         String  
  category      String  

  // Content
  content       String  

  // Versioning
  version       String  
  status        String    // DRAFT, ACTIVE, SUPERSEDED

  // Applicability
  isGlobal      Boolean  @default(false) @map("is_global")
  isMandatory   Boolean  @default(false) @map("is_mandatory")
  applicableTo  Json @map("applicable_to")

  // Ownership
  createdBy     String   @map("created_by")

  // Dates
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([category])
  @@index([status])
  @@index([isGlobal])
  @@map("governance_frameworks")
}

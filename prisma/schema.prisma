// This is your Prisma schema file
// STRICT: Use ONLY Prisma Migrate - NO db push --accept-data-loss
// Schema: sgm_summit_demo (isolated from other schemas)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// TENANT & AUTH MODELS
// =============================================================================

// Tenant Model - Multi-tenancy support
model Tenant {
  id        String   @id @default(cuid())
  name      String  
  slug      String   @unique

  // Tier & Status
  tier      TenantTier
  status    TenantStatus

  // Features & Settings (JSON for flexibility)
  features  Json     // maxDocuments, maxUsers, aiEnabled, etc.
  settings  Json     // branding, industry, customizations

  // Lifecycle
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  expiresAt DateTime? @map("expires_at") // For trial/beta tenants

  // Relations
  users      User[]
  policies   Policy[]
  territories Territory[]
  documents  Document[]
  approvals  Approval[]
  auditLogs  AuditLog[]
  committees Committee[]
  cases      Case[]
  planTemplates PlanTemplate[]
  plans      Plan[]
  governanceFrameworks GovernanceFramework[]
  clientEngagement ClientEngagement?

  @@index([slug])
  @@index([status])
  @@index([tier])
  @@map("tenants")
}

enum TenantTier {
  DEMO
  BETA
  PRODUCTION
}

enum TenantStatus {
  ACTIVE
  SUSPENDED
  TRIAL
  EXPIRED
}

// User Model - NextAuth compatible
model User {
  id            String    @id @default(cuid())
  name          String?  
  email         String    @unique
  emailVerified DateTime? @map("email_verified")
  image         String?  

  // Role & Tenant
  role          UserRole  @default(USER)
  tenantId      String    @map("tenant_id")
  tenant        Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // NextAuth relations
  accounts      Account[]
  sessions      Session[]

  // Audit
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([email])
  @@map("users")
}

enum UserRole {
  SUPER_ADMIN  // Platform admin (cross-tenant)
  ADMIN        // Tenant admin
  MANAGER      // Committee member, can approve
  USER         // Standard user
  VIEWER       // Read-only access
}

// Account Model - NextAuth OAuth accounts
model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String 
  provider          String 
  providerAccountId String  @map("provider_account_id")
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

// Session Model - NextAuth sessions
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

// VerificationToken Model - NextAuth email verification
model VerificationToken {
  identifier String  
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// =============================================================================
// GOVERNANCE MODELS (with tenant relations)
// =============================================================================

// Policy Model
model Policy {
  id        String   @id @default(cuid())
  tenantId  String   @map("tenant_id")
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Metadata
  name        String  
  description String? 
  category    String? 

  // Versioning
  version     String  
  status      String   // draft, published, superseded, retired

  // Effective Dating
  effectiveDate   DateTime  @map("effective_date")
  expirationDate  DateTime? @map("expiration_date")

  // Content
  content String

  // Relationships
  parentPolicyId      String?  @map("parent_policy_id")
  supersededByPolicyId String? @map("superseded_by_policy_id")

  // Approval
  approvalRequired    Boolean   @default(true) @map("approval_required")
  approvalWorkflowId  String?   @map("approval_workflow_id")
  approvedBy          String?   @map("approved_by")
  approvedAt          DateTime? @map("approved_at")

  // Audit
  createdBy String    @map("created_by")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedBy String?   @map("updated_by")
  updatedAt DateTime? @updatedAt @map("updated_at")

  // Metadata JSON
  metadata Json?

  // Demo Data Management
  isDemo         Boolean  @default(false) @map("is_demo")
  demoMetadata   Json?    @map("demo_metadata") // year, BU, division, category

  @@index([tenantId])
  @@index([status])
  @@index([effectiveDate])
  @@index([isDemo])
  @@map("policies")
}

// Territory Model
model Territory {
  id        String   @id @default(cuid())
  tenantId  String   @map("tenant_id")
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Metadata
  code        String 
  name        String 
  description String?
  type        String  // geographic, account, industry, named
  status      String  // active, inactive, archived

  // Hierarchy
  parentTerritoryId String? @map("parent_territory_id")
  level             Int     @default(0)
  path              String?

  // Assignment
  assignedToUserId String?   @map("assigned_to_user_id")
  assignedAt       DateTime? @map("assigned_at")

  // Coverage Rules
  coverageRules Json? @map("coverage_rules")

  // Effective Dating
  effectiveDate   DateTime  @map("effective_date")
  expirationDate  DateTime? @map("expiration_date")

  // Audit
  createdBy String    @map("created_by")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedBy String?   @map("updated_by")
  updatedAt DateTime? @updatedAt @map("updated_at")

  // Metadata
  metadata Json?

  // Demo Data Management
  isDemo         Boolean  @default(false) @map("is_demo")
  demoMetadata   Json?    @map("demo_metadata") // year, BU, division, category

  @@index([tenantId])
  @@index([status])
  @@index([type])
  @@index([parentTerritoryId])
  @@index([isDemo])
  @@map("territories")
}

// Document Model
model Document {
  id           String   @id @default(cuid())
  tenantId     String   @map("tenant_id")
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  documentCode String   @map("document_code")

  // Metadata
  title         String  
  description   String? 
  documentType  String   @map("document_type")
  category      String? 
  tags          Json

  // Versioning
  version String
  status  String

  // Lifecycle Dates
  createdAt       DateTime  @default(now()) @map("created_at")
  lastUpdated     DateTime  @updatedAt @map("last_updated")
  effectiveDate   DateTime? @map("effective_date")
  expirationDate  DateTime? @map("expiration_date")
  nextReview      DateTime? @map("next_review")

  // File Storage
  fileType String @map("file_type")
  filePath String @map("file_path")
  fileSize Int    @map("file_size")
  checksum String?

  // Ownership & Approval
  owner               String 
  createdBy           String  @map("created_by")
  updatedBy           String? @map("updated_by")
  approvers           Json?  
  approvalWorkflowId  String? @map("approval_workflow_id")
  legalReviewStatus   String  @default("NOT_REQUIRED") @map("legal_review_status")

  // Relationships
  relatedDocs   Json @map("related_docs")
  referencedBy  Json @map("referenced_by")
  supersedes    String? 
  supersededBy  String?  @map("superseded_by")

  // Compliance
  retentionPeriod  Int      @default(7) @map("retention_period")
  complianceFlags  Json @map("compliance_flags")

  // Metadata
  metadata Json?

  // Demo Data Management
  isDemo         Boolean  @default(false) @map("is_demo")
  demoMetadata   Json?    @map("demo_metadata") // year, BU, division, category

  @@unique([tenantId, documentCode])
  @@index([tenantId])
  @@index([documentType])
  @@index([status])
  @@index([isDemo])
  @@map("documents")
}

// Document Version Model - Full Provenance Tracking
model DocumentVersion {
  id           String   @id @default(cuid())
  tenantId     String   @map("tenant_id")
  documentId   String   @map("document_id")

  // Version Identity
  versionNumber     String  @map("version_number")  // "1.0", "1.1", "2.0"
  versionLabel      String? @map("version_label")   // "Initial Draft", "Q1 2025 Update"

  // Lifecycle Status
  lifecycleStatus   String  @map("lifecycle_status")  // RAW, PROCESSED, DRAFT, UNDER_REVIEW, APPROVED, ACTIVE_FINAL, SUPERSEDED, ARCHIVED

  // Content Storage
  content           String  // The actual document content (markdown, JSON, etc.)
  contentFormat     String  @default("markdown") @map("content_format")  // markdown, json, html

  // Source File Tracking
  sourceFileUrl     String? @map("source_file_url")   // Path to original RAW file
  sourceFileName    String? @map("source_file_name")  // Original filename
  sourceFileType    String? @map("source_file_type")  // pdf, docx, xlsx

  // Provenance & Audit Trail
  createdBy         String  @map("created_by")
  createdAt         DateTime @default(now()) @map("created_at")
  modifiedBy        String? @map("modified_by")
  modifiedAt        DateTime? @map("modified_at")
  changeDescription String? @map("change_description")  // Why this version was created
  changeType        String  @default("MINOR") @map("change_type")  // MAJOR, MINOR, PATCH, EMERGENCY

  // Approval Tracking
  approvedBy        String? @map("approved_by")
  approvedAt        DateTime? @map("approved_at")
  approvalComments  String? @map("approval_comments")

  // Published/Active Tracking
  publishedBy       String? @map("published_by")
  publishedAt       DateTime? @map("published_at")

  // Data Integrity
  checksum          String  // MD5/SHA256 hash of content for integrity verification
  fileSize          Int     @default(0) @map("file_size")  // Size in bytes

  // Relationships to Previous/Next Versions
  previousVersionId String? @map("previous_version_id")
  supersededBy      String? @map("superseded_by")  // ID of version that replaced this

  // Metadata
  metadata          Json?  // Additional version-specific metadata

  // Demo Data Management
  isDemo            Boolean @default(false) @map("is_demo")

  @@unique([documentId, versionNumber])
  @@index([tenantId])
  @@index([documentId])
  @@index([lifecycleStatus])
  @@index([createdAt])
  @@index([publishedAt])
  @@map("document_versions")
}

// Approval Model
model Approval {
  id        String   @id @default(cuid())
  tenantId  String   @map("tenant_id")
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Metadata
  title       String 
  description String?
  priority    String  @default("medium")
  status      String  @default("pending")

  // Request Details
  entityType  String @map("entity_type")
  entityId    String @map("entity_id")
  requestType String @map("request_type")
  requestData Json   @map("request_data")

  // Workflow
  workflowId  String? @map("workflow_id")
  currentStep Int     @default(0) @map("current_step")
  totalSteps  Int     @default(1) @map("total_steps")

  // Submitter
  submittedBy String   @map("submitted_by")
  submittedAt DateTime @default(now()) @map("submitted_at")

  // SLA
  slaDeadline DateTime? @map("sla_deadline")
  escalatedAt DateTime? @map("escalated_at")

  // Resolution
  decidedBy    String?   @map("decided_by")
  decidedAt    DateTime? @map("decided_at")
  decision     String?  
  decisionNotes String?  @map("decision_notes")

  // Audit
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")

  // Metadata
  metadata Json?

  // Demo Data Management
  isDemo         Boolean  @default(false) @map("is_demo")
  demoMetadata   Json?    @map("demo_metadata") // year, BU, division, category

  @@index([tenantId])
  @@index([status])
  @@index([entityType, entityId])
  @@index([isDemo])
  @@map("approvals")
}

// Audit Log Model
model AuditLog {
  id       String @id @default(cuid())
  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Event Details
  eventType String @map("event_type")
  severity  String @default("info")
  message   String

  // Entity Context
  entityType String  @map("entity_type")
  entityId   String  @map("entity_id")
  entityName String? @map("entity_name")

  // Actor
  actorId   String  @map("actor_id")
  actorName String? @map("actor_name")
  actorRole String? @map("actor_role")

  // Changes
  changesBefore Json? @map("changes_before")
  changesAfter  Json? @map("changes_after")

  // Request Context
  requestId String? @map("request_id")
  ipAddress String? @map("ip_address")
  userAgent String? @map("user_agent")

  // Timestamp (immutable)
  occurredAt DateTime @default(now()) @map("occurred_at")

  // Metadata
  metadata Json?

  @@index([tenantId])
  @@index([eventType])
  @@index([entityType, entityId])
  @@index([actorId])
  @@index([occurredAt])
  @@map("audit_logs")
}

// Committee Model
model Committee {
  id       String @id @default(cuid())
  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Metadata
  code        String 
  name        String 
  description String?
  type        String  // SGCC, CRB, etc.

  // Charter
  charter            String?
  meetingFrequency   String? @map("meeting_frequency")
  quorumRequirement  Int?    @map("quorum_requirement")

  // Members (stored as JSON for flexibility)
  votingMembers    Json? @map("voting_members")
  nonVotingMembers Json? @map("non_voting_members")
  advisors         Json?

  // Authority
  approvalAuthority Json? @map("approval_authority")

  // Status
  status String @default("active")

  // Audit
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")

  // Metadata
  metadata Json?

  // Demo Data Management
  isDemo         Boolean  @default(false) @map("is_demo")
  demoMetadata   Json?    @map("demo_metadata") // year, BU, division, category

  @@index([tenantId])
  @@index([type])
  @@index([status])
  @@index([isDemo])
  @@unique([tenantId, code])
  @@map("committees")
}

// Case Model
model Case {
  id       String @id @default(cuid())
  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Metadata
  caseNumber  String  @unique @map("case_number")
  title       String 
  description String?
  caseType    String  @map("case_type")
  priority    String  @default("MEDIUM")
  status      String  @default("NEW")

  // Assignment
  assignedTo   String?   @map("assigned_to")
  committeeId  String?   @map("committee_id")

  // Submitter
  submittedBy  String    @map("submitted_by")
  submittedAt  DateTime  @default(now()) @map("submitted_at")

  // Financial Impact
  financialImpact     Decimal? @map("financial_impact")
  financialImpactType String?  @map("financial_impact_type")

  // Resolution
  resolvedBy  String?   @map("resolved_by")
  resolvedAt  DateTime? @map("resolved_at")
  resolution  String?  

  // SLA
  slaDeadline      DateTime? @map("sla_deadline")
  businessDaysUsed Int?      @map("business_days_used")
  isOverdue        Boolean   @default(false) @map("is_overdue")

  // Timeline (stored as JSON array)
  timeline Json?

  // Attachments
  attachments Json?

  // Audit
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")

  // Metadata
  metadata Json?

  // Demo Data Management
  isDemo         Boolean  @default(false) @map("is_demo")
  demoMetadata   Json?    @map("demo_metadata") // year, BU, division, category

  @@index([tenantId])
  @@index([caseType])
  @@index([status])
  @@index([priority])
  @@index([assignedTo])
  @@index([submittedAt])
  @@index([isDemo])
  @@map("cases")
}

// =============================================================================
// PLAN MANAGEMENT MODELS
// =============================================================================

// Plan Template Model - Reusable templates for creating plans
model PlanTemplate {
  id                String   @id @default(cuid())
  tenantId          String   @map("tenant_id")
  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Metadata
  code              String   @unique
  name              String  
  description       String? 
  planType          String   @map("plan_type")  // COMPENSATION_PLAN, GOVERNANCE_PLAN, POLICY_CREATION_PLAN
  category          String? 
  tags              Json

  // Versioning
  version           String  
  status            String    // DRAFT, ACTIVE, DEPRECATED, ARCHIVED

  // Source & Cloning
  source            String    // SYSTEM, USER_CREATED, CLONED
  isSystemTemplate  Boolean  @default(false) @map("is_system_template")
  clonedFromId      String?  @map("cloned_from_id")

  // Ownership
  owner             String  
  createdBy         String   @map("created_by")

  // Dates
  createdAt         DateTime @default(now()) @map("created_at")
  lastUpdated       DateTime @updatedAt @map("last_updated")
  effectiveDate     DateTime? @map("effective_date")

  // Usage Stats
  usageCount        Int      @default(0) @map("usage_count")

  // Metadata JSON
  metadata          Json?

  // Demo Data Management
  isDemo            Boolean  @default(false) @map("is_demo")
  demoMetadata      Json?    @map("demo_metadata") // year, BU, division, category

  // Relations
  sections          TemplateSection[]
  plans             Plan[]   @relation("PlanToTemplate")

  @@index([tenantId])
  @@index([planType])
  @@index([status])
  @@index([isSystemTemplate])
  @@index([isDemo])
  @@map("plan_templates")
}

// Template Section Model - Sections within a plan template
model TemplateSection {
  id                String        @id @default(cuid())
  templateId        String        @map("template_id")
  template          PlanTemplate  @relation(fields: [templateId], references: [id], onDelete: Cascade)

  // Hierarchy
  parentSectionId   String?       @map("parent_section_id")
  sectionKey        String        @map("section_key")
  level             Int           @default(0)
  orderIndex        Int           @map("order_index")

  // Metadata
  title             String       
  description       String?      

  // Requirements
  isRequired        Boolean       @default(false) @map("is_required")
  isRepeatable      Boolean       @default(false) @map("is_repeatable")

  // Content Template
  contentTemplate   String?       @map("content_template")

  // Field Definitions (JSON array of FieldDefinition objects)
  fieldDefinitions  Json?         @map("field_definitions")

  // AI Agent Roles
  aiAgentRoles      Json      @map("ai_agent_roles")

  // Metadata
  metadata          Json?        

  @@index([templateId])
  @@index([parentSectionId])
  @@map("template_sections")
}

// Plan Model - Instance of a plan being created/edited
model Plan {
  id                      String      @id @default(cuid())
  tenantId                String      @map("tenant_id")
  tenant                  Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Metadata
  planCode                String      @unique @map("plan_code")
  title                   String     
  description             String?    
  planType                String      @map("plan_type")
  category                String?    
  tags                    Json   

  // Versioning
  version                 String     
  status                  String       // DRAFT, IN_PROGRESS, UNDER_REVIEW, PENDING_APPROVAL, APPROVED, PUBLISHED, SUPERSEDED, ARCHIVED

  // Template Relationship
  createdFromTemplateId   String?     @map("created_from_template_id")
  template                PlanTemplate? @relation("PlanToTemplate", fields: [createdFromTemplateId], references: [id])
  templateSnapshot        Json?       @map("template_snapshot")

  // Ownership
  owner                   String     
  createdBy               String      @map("created_by")
  updatedBy               String?     @map("updated_by")

  // Approval
  approvalWorkflowId      String?     @map("approval_workflow_id")

  // Dates
  createdAt               DateTime    @default(now()) @map("created_at")
  lastUpdated             DateTime    @updatedAt @map("last_updated")
  effectiveDate           DateTime?   @map("effective_date")
  expirationDate          DateTime?   @map("expiration_date")
  publishedAt             DateTime?   @map("published_at")

  // Document Link
  documentId              String?     @map("document_id")

  // Versioning Chain
  supersedes              String?
  supersededBy            String?     @map("superseded_by")

  // Completion Tracking
  completionPercentage    Int         @default(0) @map("completion_percentage")
  sectionsCompleted       Int         @default(0) @map("sections_completed")
  sectionsTotal           Int         @default(0) @map("sections_total")

  // Metadata
  metadata                Json?

  // Demo Data Management
  isDemo                  Boolean  @default(false) @map("is_demo")
  demoMetadata            Json?    @map("demo_metadata") // year, BU, division, category

  // Relations
  sections                PlanSection[]

  @@index([tenantId])
  @@index([planType])
  @@index([status])
  @@index([owner])
  @@index([createdFromTemplateId])
  @@index([isDemo])
  @@map("plans")
}

// Plan Section Model - Individual section within a plan instance
model PlanSection {
  id                    String      @id @default(cuid())
  planId                String      @map("plan_id")
  plan                  Plan        @relation(fields: [planId], references: [id], onDelete: Cascade)

  // Hierarchy
  parentSectionId       String?     @map("parent_section_id")
  sectionKey            String      @map("section_key")
  level                 Int         @default(0)
  orderIndex            Int         @map("order_index")

  // Metadata
  title                 String     
  description           String?    

  // Requirements
  isRequired            Boolean     @default(false) @map("is_required")

  // Content
  content               String?     // @deprecated - Use contentJson for new content
  contentJson           Json?       @map("content_json") // Structured JSON content (blocks)

  // Field Values (JSON array of FieldValue objects)
  fieldValues           Json?       @map("field_values")

  // AI Agent Roles
  aiAgentRoles          Json    @map("ai_agent_roles")

  // Completion Tracking
  completionStatus      String      @default("NOT_STARTED") @map("completion_status")
  completionPercentage  Int         @default(0) @map("completion_percentage")

  // Review
  reviewedBy            String?     @map("reviewed_by")
  reviewedAt            DateTime?   @map("reviewed_at")
  reviewComments        String?     @map("review_comments")

  // Dates
  createdAt             DateTime    @default(now()) @map("created_at")
  lastUpdated           DateTime    @updatedAt @map("last_updated")

  // Metadata
  metadata              Json?      

  @@index([planId])
  @@index([parentSectionId])
  @@index([completionStatus])
  @@map("plan_sections")
}

// Governance Framework Model - SPM methodology and governance guardrails
model GovernanceFramework {
  id            String   @id @default(cuid())
  tenantId      String   @map("tenant_id")
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Metadata
  code          String   @unique
  title         String  
  category      String  

  // Content
  content       String  

  // Versioning
  version       String  
  status        String    // DRAFT, ACTIVE, SUPERSEDED

  // Applicability
  isGlobal      Boolean  @default(false) @map("is_global")
  isMandatory   Boolean  @default(false) @map("is_mandatory")
  applicableTo  Json @map("applicable_to")

  // Ownership
  createdBy     String   @map("created_by")

  // Dates
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([category])
  @@index([status])
  @@index([isGlobal])
  @@map("governance_frameworks")
}

// =============================================================================
// CLIENT DASHBOARD MODELS (Phase 5)
// =============================================================================

// Client Engagement Model - Consulting engagement tracking
model ClientEngagement {
  id              String   @id @default(cuid())
  tenantId        String   @unique @map("tenant_id")
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Engagement Type
  type            String   // GAP_ANALYSIS, FULL_IMPLEMENTATION, AUDIT, CONSULTING

  // Status
  status          String   // ACTIVE, PAUSED, COMPLETED, ARCHIVED

  // Timeline
  startDate       DateTime @map("start_date")
  targetEndDate   DateTime? @map("target_end_date")
  actualEndDate   DateTime? @map("actual_end_date")

  // Team
  consultantTeam  Json     @map("consultant_team")  // Array of consultant user IDs
  clientContacts  Json     @map("client_contacts")  // Array of client contact info

  // Branding (White-label support)
  brandingConfig  Json?    @map("branding_config")  // Logo, colors, company name

  // Metadata
  metadata        Json?

  // Audit
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  plans           ClientPlanAnalysis[]
  gaps            ClientGapAnalysis[]
  roadmapPhases   ClientRoadmapPhase[]

  @@index([status])
  @@index([type])
  @@map("client_engagements")
}

// Client Plan Analysis Model - Gap analysis results for each plan
model ClientPlanAnalysis {
  id              String   @id @default(cuid())
  engagementId    String   @map("engagement_id")
  engagement      ClientEngagement @relation(fields: [engagementId], references: [id], onDelete: Cascade)

  // Plan Identity
  planCode        String   @map("plan_code")
  planName        String   @map("plan_name")
  planType        String?  @map("plan_type")  // SALES, SERVICE, EXECUTIVE
  businessUnit    String?  @map("business_unit")

  // Coverage Scores
  coverageFull    Int      @map("coverage_full")     // Count of Full Coverage policies
  coverageLimited Int      @map("coverage_limited")  // Count of Limited Coverage policies
  coverageNo      Int      @map("coverage_no")       // Count of No Coverage policies

  // Risk Assessment
  riskScore       Int      @map("risk_score")        // 0-100 risk score

  // Policy Coverage Details (JSON)
  policyCoverage  Json     @map("policy_coverage")   // Detailed policy mapping

  // Metadata
  metadata        Json?

  // Audit
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@index([engagementId])
  @@index([planCode])
  @@unique([engagementId, planCode])
  @@map("client_plan_analyses")
}

// Client Gap Analysis Model - Individual gaps identified
model ClientGapAnalysis {
  id                String   @id @default(cuid())
  engagementId      String   @map("engagement_id")
  engagement        ClientEngagement @relation(fields: [engagementId], references: [id], onDelete: Cascade)

  // Gap Identity
  planCode          String   @map("plan_code")
  policyArea        String   @map("policy_area")     // SGCC, CRB, Windfall Deals, etc.

  // Description
  gapDescription    String   @map("gap_description")

  // Severity
  severity          String   // CRITICAL, HIGH, MEDIUM, LOW

  // Status
  status            String   // OPEN, PLANNED, IN_PROGRESS, RESOLVED, WONT_FIX

  // Reference
  bhgPolicyRef      String?  @map("bhg_policy_ref")  // Reference to BHG best practice policy

  // Assignment
  assignedTo        String?  @map("assigned_to")
  dueDate           DateTime? @map("due_date")

  // Resolution
  resolvedBy        String?  @map("resolved_by")
  resolvedAt        DateTime? @map("resolved_at")
  resolutionNotes   String?  @map("resolution_notes")

  // Metadata
  metadata          Json?

  // Audit
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@index([engagementId])
  @@index([planCode])
  @@index([severity])
  @@index([status])
  @@map("client_gap_analyses")
}

// Client Roadmap Phase Model - Implementation roadmap phases
model ClientRoadmapPhase {
  id              String   @id @default(cuid())
  engagementId    String   @map("engagement_id")
  engagement      ClientEngagement @relation(fields: [engagementId], references: [id], onDelete: Cascade)

  // Phase Identity
  phase           String   // "Weeks 1-3", "Weeks 4-6", "Weeks 7-10", etc.
  orderIndex      Int      @map("order_index")

  // Content
  title           String
  description     String?

  // Milestones (JSON array)
  milestones      Json     // Array of milestone objects

  // Status
  status          String   // NOT_STARTED, IN_PROGRESS, COMPLETED, BLOCKED
  completionPct   Int      @default(0) @map("completion_pct")

  // Timeline
  startDate       DateTime? @map("start_date")
  targetEndDate   DateTime? @map("target_end_date")
  actualEndDate   DateTime? @map("actual_end_date")

  // Metadata
  metadata        Json?

  // Audit
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@index([engagementId])
  @@index([orderIndex])
  @@index([status])
  @@map("client_roadmap_phases")
}

// =============================================================================
// DOCUMENT INGESTION MODELS (Phase 7 - JSON Content System)
// =============================================================================

// Uploaded Document Model - Tracks uploaded documents for plan creation
model UploadedDocument {
  id              String   @id @default(cuid())
  tenantId        String   @map("tenant_id")

  // File metadata
  fileName        String   @map("file_name")
  fileType        String   @map("file_type")  // pdf, docx, txt, xlsx
  fileSize        Int      @map("file_size")
  filePath        String   @map("file_path")
  checksum        String   // SHA-256

  // Processing status
  status          DocumentIngestionStatus
  uploadedBy      String   @map("uploaded_by")
  uploadedAt      DateTime @default(now()) @map("uploaded_at")

  // Extracted content (JSON)
  parsedContent   Json?    @map("parsed_content")  // Structured JSON from document
  parsedAt        DateTime? @map("parsed_at")

  // Statistics
  totalSections   Int?     @map("total_sections")
  totalWords      Int?     @map("total_words")
  processingTime  Int?     @map("processing_time")  // milliseconds

  // Created plan
  planId          String?  @map("plan_id")

  // Error tracking
  errorMessage    String?  @map("error_message")

  // Relations
  sectionMappings SectionMapping[]
  policyRecommendations PolicyRecommendation[]

  @@index([tenantId, status])
  @@index([uploadedBy])
  @@index([uploadedAt])
  @@map("uploaded_documents")
}

enum DocumentIngestionStatus {
  UPLOADED
  PARSING
  PARSED
  MAPPING
  MAPPED
  ANALYZING
  ANALYZED
  READY
  COMPLETED
  FAILED
}

// Section Mapping Model - Links parsed sections to template sections
model SectionMapping {
  id                  String   @id @default(cuid())
  documentId          String   @map("document_id")
  document            UploadedDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  // Source from document (JSON structure)
  detectedTitle       String   @map("detected_title")
  detectedContent     Json     @map("detected_content")  // { title, content, blocks, pageRange }

  // Target template section
  templateSectionId   String   @map("template_section_id")
  templateSectionKey  String   @map("template_section_key")
  templateSectionTitle String  @map("template_section_title")

  // AI confidence
  confidenceScore     Float    @map("confidence_score")
  mappingMethod       String   @map("mapping_method")  // EXACT, FUZZY, AI_SUGGESTED, MANUAL

  // Status
  status              MappingStatus

  // Alternative suggestions (JSON)
  alternatives        Json?    // Array of { templateSectionId, score }

  // Metadata
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  reviewedBy          String?  @map("reviewed_by")
  reviewedAt          DateTime? @map("reviewed_at")

  @@index([documentId])
  @@index([status])
  @@index([confidenceScore])
  @@map("section_mappings")
}

enum MappingStatus {
  PENDING
  ACCEPTED
  REJECTED
  MODIFIED
}

// Policy Recommendation Model - Stores policy recommendations for gaps
model PolicyRecommendation {
  id               String   @id @default(cuid())
  documentId       String?  @map("document_id")
  document         UploadedDocument? @relation(fields: [documentId], references: [id], onDelete: Cascade)
  planId           String?  @map("plan_id")
  gapId            String?  @map("gap_id")

  // Policy reference
  policyCode       String   @map("policy_code")
  policyData       Json     @map("policy_data")  // Full policy JSON

  // Recommendation details (JSON)
  recommendationDetails Json  @map("recommendation_details")  // { targetSectionKey, action, insertPosition, contentJson, etc. }

  // Priority & Severity
  priority         String   // CRITICAL, HIGH, MEDIUM, LOW
  severity         String   // From gap analysis

  // Status
  status           RecommendationStatus
  appliedAt        DateTime? @map("applied_at")
  appliedBy        String?  @map("applied_by")
  applicationNotes String?  @map("application_notes")

  // Metadata
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  @@index([documentId])
  @@index([planId, status])
  @@index([policyCode])
  @@index([priority])
  @@map("policy_recommendations")
}

enum RecommendationStatus {
  PENDING
  APPLIED
  REJECTED
  PARTIALLY_APPLIED
}

// =============================================================================
// GOVERNANCE REVIEW MODELS (AI-Powered Gap Analysis)
// =============================================================================

// Governance Review Model - AI-powered gap analysis results
model GovernanceReview {
  id              String   @id @default(cuid())
  tenantId        String   @map("tenant_id")

  // Document Reference
  documentId      String?  @map("document_id")
  planName        String   @map("plan_name")
  planType        String?  @map("plan_type")  // COMPENSATION_PLAN, POLICY, etc.
  jurisdiction    String   @default("DEFAULT")

  // Analysis Results
  coverageScore   Float    @map("coverage_score")  // 0.0 - 1.0
  liabilityScore  Float    @map("liability_score")  // 0.0 - 5.0
  totalPolicies   Int      @map("total_policies")
  totalGaps       Int      @map("total_gaps")

  // Gap Summary by Status
  evidenced       Int      @default(0)
  partial         Int      @default(0)
  notEvidenced    Int      @default(0) @map("not_evidenced")

  // AI Validation Summary
  aiValidated           Boolean  @default(false) @map("ai_validated")
  aiConfirmedGaps       Int      @default(0) @map("ai_confirmed_gaps")
  aiFalsePositives      Int      @default(0) @map("ai_false_positives")
  avgAiConfidence       Float?   @map("avg_ai_confidence")

  // Report Generation
  htmlReport      String?  @map("html_report")
  pdfReportUrl    String?  @map("pdf_report_url")

  // Organization Context
  organizationName  String?  @map("organization_name")
  organizationState String?  @map("organization_state")

  // Risk Triggers (JSON array)
  riskTriggers    Json?    @map("risk_triggers")

  // Raw Analysis Data (full GovLens response)
  rawAnalysis     Json?    @map("raw_analysis")

  // Audit
  analyzedBy      String?  @map("analyzed_by")
  analyzedAt      DateTime @default(now()) @map("analyzed_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Demo flag
  isDemo          Boolean  @default(false) @map("is_demo")

  // Relations
  gaps            GovernanceGap[]
  conversations   GovernanceConversation[]

  @@index([tenantId])
  @@index([documentId])
  @@index([analyzedAt])
  @@index([coverageScore])
  @@index([isDemo])
  @@map("governance_reviews")
}

// Governance Gap Model - Individual gap findings with AI validation
model GovernanceGap {
  id              String   @id @default(cuid())
  reviewId        String   @map("review_id")
  review          GovernanceReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  // Policy Reference
  policyCode      String   @map("policy_code")     // A-001, B-002, etc.
  policyName      String   @map("policy_name")
  policyCategory  String?  @map("policy_category") // A=Definitions, B=Performance, etc.
  requirementId   String?  @map("requirement_id")
  requirementName String?  @map("requirement_name")

  // Detection Results
  finding         GapFinding  // EVIDENCED, PARTIAL, NOT_EVIDENCED
  severity        GapSeverity
  evidence        Json?       // Array of evidence strings
  missingElements Json?       @map("missing_elements")  // Array of missing elements

  // AI Validation
  aiValidated     Boolean  @default(false) @map("ai_validated")
  aiIsGap         Boolean? @map("ai_is_gap")
  aiConfidence    Int?     @map("ai_confidence")  // 0-100
  aiReasoning     String?  @map("ai_reasoning")
  aiSuggestedGrade String? @map("ai_suggested_grade")  // A, B, C
  aiValidatedAt   DateTime? @map("ai_validated_at")

  // Remediation
  remediationGenerated Boolean  @default(false) @map("remediation_generated")
  remediationText      String?  @map("remediation_text")
  remediationInsertionPoint String? @map("remediation_insertion_point")
  remediationIntegrationNotes String? @map("remediation_integration_notes")
  remediationConflictWarnings Json?   @map("remediation_conflict_warnings")
  remediationConfidence Int?    @map("remediation_confidence")
  remediationGeneratedAt DateTime? @map("remediation_generated_at")

  // User Disposition (action taken by user)
  disposition     GapDisposition @default(PENDING)
  dispositionNotes String?  @map("disposition_notes")
  dispositionBy   String?  @map("disposition_by")
  dispositionAt   DateTime? @map("disposition_at")

  // Audit
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@index([reviewId])
  @@index([policyCode])
  @@index([finding])
  @@index([severity])
  @@index([aiValidated])
  @@index([disposition])
  @@map("governance_gaps")
}

enum GapFinding {
  EVIDENCED
  PARTIAL
  NOT_EVIDENCED
}

enum GapSeverity {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum GapDisposition {
  PENDING           // Not yet reviewed
  GAP_CONFIRMED     // User confirmed it's a gap
  COVERED_ELSEWHERE // Coverage exists in another document
  NOT_APPLICABLE    // Policy doesn't apply to this plan
  REMEDIATION_ADDED // Fix has been applied
  WONT_FIX          // Accepted risk
}

// Governance Conversation Model - Chat history with The Toddfather
model GovernanceConversation {
  id              String   @id @default(cuid())
  tenantId        String   @map("tenant_id")

  // Optional Review Context
  reviewId        String?  @map("review_id")
  review          GovernanceReview? @relation(fields: [reviewId], references: [id], onDelete: SetNull)

  // AICR Conversation Reference
  aicrConversationId String @map("aicr_conversation_id")

  // Context at conversation start
  contextSnapshot Json?    @map("context_snapshot")  // { planName, gaps, coverage }

  // Message Count (for quick stats)
  messageCount    Int      @default(0) @map("message_count")

  // User
  userId          String?  @map("user_id")

  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  lastMessageAt   DateTime @default(now()) @map("last_message_at")

  @@index([tenantId])
  @@index([reviewId])
  @@index([aicrConversationId])
  @@index([lastMessageAt])
  @@map("governance_conversations")
}
